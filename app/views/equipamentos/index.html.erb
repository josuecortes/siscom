<% content_for :title do %>
  <i class="fas fa-desktop"></i> Equipamentos
<% end %>
<% content_for :breadcrumb do %>
  <li class="breadcrumb-item active"><a href="<%= equipamentos_url %>">Equipamentos</a></li>
<% end %>
<% content_for :sub_title do %>
  Lista de equipamentos
<% end %>
<% content_for :buttons do %>
  <%= link_to new_equipamento_path, class: "btn btn-sm btn-success", title: "Novo Equipamento", remote: true do %>
    <i class="fas fa-plus"></i> Novo
  <% end %>
  <%= link_to exportar_excel_equipamentos_path(request.query_parameters.merge(format: :xlsx)), class: "btn btn-sm btn-warning", title: "Exportar para Excel" do %>
    <i class="fas fa-file-excel"></i> Exportar Excel
  <% end %>
<% end %>

<!-- Filtros -->
<div class="card mb-3">
  <div class="card-header">
    <h5 class="card-title">Filtros</h5>
  </div>
  <div class="card-body">
    <%= form_with url: equipamentos_path, method: :get, local: true do |f| %>
      <div class="row">
        <div class="col-md-2">
          <%= f.label :busca, "Buscar", class: "form-label" %>
          <%= f.text_field :busca, value: params[:busca], class: "form-control", placeholder: "Nome, marca, modelo, serial..." %>
        </div>
        <div class="col-md-2">
          <%= f.label :tipo, "Tipo", class: "form-label" %>
          <%= f.select :tipo, options_for_select([['Todos', ''], ['Individual', 'individual']], params[:tipo]), {}, class: "form-control" %>
        </div>
        <div class="col-md-2">
          <%= f.label :tipo_equipamento, "Tipo de Equipamento", class: "form-label" %>
          <%= f.select :tipo_equipamento, options_for_select([['Todos', '']] + @tipos_equipamento.map { |t| [t, t] }, params[:tipo_equipamento]), {}, class: "form-control" %>
        </div>
        <div class="col-md-2">
          <%= f.label :status, "Status", class: "form-label" %>
          <%= f.select :status, options_for_select([['Todos', '']] + @status_list.map { |s| [s.humanize, s] }, params[:status]), {}, class: "form-control" %>
        </div>
        <div class="col-md-2">
          <%= f.label :unidade_id, "Unidade", class: "form-label" %>
          <%= f.select :unidade_id, options_for_select([['Todas', '']] + @unidades.map { |u| [u.sigla_nome, u.id] }, params[:unidade_id]), {}, class: "form-control" %>
        </div>
        <div class="col-md-2">
          <%= f.label :contrato, "Contrato/Referência", class: "form-label" %>
          <%= f.text_field :contrato, value: params[:contrato], class: "form-control", placeholder: "Digite o contrato..." %>
        </div>
      </div>
      <div class="row mt-2">
        <div class="col-md-2">
          <%= f.label :codigo_kit, "Código do Kit", class: "form-label" %>
          <%= f.text_field :codigo_kit, value: params[:codigo_kit], class: "form-control", placeholder: "Digite o código do kit..." %>
        </div>
        <div class="col-md-2">
          <%= f.label :processo, "Processo", class: "form-label" %>
          <%= f.text_field :processo, value: params[:processo], class: "form-control", placeholder: "Digite o processo..." %>
        </div>
        <div class="col-12">
          <br>
          <%= f.submit "Filtrar", class: "btn btn-info btn-sm" %>
          <%= link_to "Limpar", equipamentos_path, class: "btn btn-secondary btn-sm" %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<!-- Tabela -->
<table id="data-table" class="table table-bordered table-hover">
  <thead>
    <tr>
      <th>Nome</th>
      <th>Tipo</th>
      <th>Identificação</th>
      <th>Unidade</th>
      <th>Contrato/Referência</th>
      <th>Código Kit</th>
      <th>Status</th>
      <th>Ações</th>
    </tr>
  </thead>
  <tbody id="data-table-body">
    <% @equipamentos.each do |equipamento| %>
      <tr>
        <td>
          <strong><%= equipamento.nome_completo %></strong>
          <% if equipamento.individual? && equipamento.marca.present? %>
            <br><small class="text-muted"><%= equipamento.marca %></small>
          <% end %>
          <% if equipamento.pertence_a_kit? %>
            <br><small class="text-primary"><i class="fas fa-box"></i> Pertence ao Kit: <%= equipamento.nome_do_kit %></small>
          <% end %>
        </td>
        <td>
          <span class="badge badge-info">
            <%= equipamento.tipo.humanize %>
          </span>
          <% if equipamento.tipo_equipamento.present? %>
            <br><small><%= equipamento.tipo_equipamento %></small>
          <% end %>
        </td>
        <td>
          <%= equipamento.identificacao_principal %>
        </td>
        <td>
          <%= equipamento.unidade.sigla_nome %>
        </td>
        <td>
          <%= equipamento.contrato.presence || '-' %>
        </td>
        <td>
          <% if equipamento.codigo_kit.present? %>
            <span class="badge badge-info"><%= equipamento.codigo_kit %></span>
          <% else %>
            -
          <% end %>
        </td>
        <td>
          <% status_class = case equipamento.status
             when 'ativo' then 'success'
             when 'inativo' then 'secondary'
             when 'em_manutencao' then 'warning'
             when 'descartado' then 'danger'
             end %>
          <span class="badge badge-<%= status_class %>">
            <%= equipamento.status.humanize %>
          </span>
        </td>
        <td>
          <%= link_to equipamento_path(equipamento), class: "btn btn-sm btn-default", title: "Ver" do %>
            <i class="fas fa-eye"></i>
          <% end %>
          <%= link_to edit_equipamento_path(equipamento), class: "btn btn-sm btn-primary", title: "Editar", remote: true do %>
            <i class="fas fa-edit"></i>
          <% end %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>

<!-- Paginação -->
<div class="d-flex justify-content-center">
  <%= paginate @equipamentos %>
</div>
