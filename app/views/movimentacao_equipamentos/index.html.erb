<% content_for :title do %>
  <i class="fas fa-exchange-alt"></i> Movimentações de Equipamentos
<% end %>

<% content_for :breadcrumb do %>
  <li class="breadcrumb-item active"><a href="<%= movimentacao_equipamentos_url %>">Movimentações</a></li>
<% end %>

<% content_for :sub_title do %>
  Lista de movimentações de equipamentos
<% end %>

<% content_for :buttons do %>
  <% if current_user.has_role?(:tec_serv_ti) %>
    <%= link_to new_movimentacao_equipamento_path, class: "btn btn-sm btn-success", title: "Nova Movimentação" do %>
      <i class="fas fa-plus"></i> Nova Movimentação
    <% end %>
  <% end %>
<% end %>

<div class="card">
  <div class="card-header">
    <h5 class="card-title">
      <% if current_user.has_role?(:tec_serv_ti) %>
        Todas as Movimentações
      <% elsif current_user.has_role?(:req_serv_ti) %>
        Minhas Movimentações Pendentes
      <% end %>
    </h5>
  </div>
  <div class="card-body">
    <div class="card mb-3">
      <div class="card-header">
        <h5 class="card-title">Filtros</h5>
      </div>
      <div class="card-body">
        <%= form_with url: movimentacao_equipamentos_path, method: :get, local: true do %>
          <div class="row">
            <div class="col-md-3 mb-2">
              <label class="form-label">Unidade</label>
              <%= hidden_field_tag :unidade_id, params[:unidade_id], id: 'mov_equip_unidade_id' %>
              <%= text_field_tag :unidade_nome, params[:unidade_nome], class: 'form-control form-control-sm js-autocomplete-unidade', autocomplete: 'off', placeholder: 'Digite para buscar unidade' %>
            </div>
            <div class="col-md-2 mb-2">
              <label class="form-label">Status</label>
              <%= select_tag :status, options_for_select([["Todos",""],["Em andamento","em_andamento"],["Concluída","concluida"],["Cancelada","cancelada"]], params[:status]), class: 'form-control form-control-sm' %>
            </div>
            <div class="col-md-3 mb-2">
              <label class="form-label">Criador</label>
              <%= hidden_field_tag :user_id, params[:user_id], id: 'mov_equip_user_id' %>
              <%= text_field_tag :user_nome, params[:user_nome], class: 'form-control form-control-sm js-autocomplete-usuario-criador', autocomplete: 'off', placeholder: 'Digite para buscar usuário' %>
            </div>
            <div class="col-md-3 mb-2">
              <label class="form-label">Responsável</label>
              <%= hidden_field_tag :responsavel_id, params[:responsavel_id], id: 'mov_equip_responsavel_id' %>
              <%= text_field_tag :responsavel_nome, params[:responsavel_nome], class: 'form-control form-control-sm js-autocomplete-usuario-responsavel', autocomplete: 'off', placeholder: 'Digite para buscar responsável' %>
            </div>
          </div>
          <div class="row mt-2">
            <div class="col-md-4 mb-2">
              <label class="form-label">Buscar Equipamento</label>
              <%= text_field_tag :q, params[:q], class: 'form-control form-control-sm', placeholder: 'Marca, modelo, tipo, serial, patrimônio, contrato, processo...' %>
            </div>
            <div class="col-12">
              <br>
              <button type="submit" class="btn btn-info btn-sm"><i class="fas fa-search"></i> Filtrar</button>
              <%= link_to "Limpar", movimentacao_equipamentos_path, class: "btn btn-secondary btn-sm" %>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <% if @movimentacoes.any? %>
      <div class="table-responsive">
        <table class="table table-bordered table-hover">
          <thead>
            <tr>
              <th>ID</th>
              <th>Origem</th>
              <th>Destino</th>
              <th>Responsável</th>
              <% if current_user.has_role?(:tec_serv_ti) %>
                <th>Criador</th>
              <% end %>
              <th>Status</th>
              <th>Equipamentos</th>
              <th>Data</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            <% @movimentacoes.each do |movimentacao| %>
              <tr>
                <td><%= movimentacao.id %></td>
                <td><%= movimentacao.unidade_origem.sigla_nome %></td>
                <td><%= movimentacao.unidade_destino.sigla_nome %></td>
                <td><%= movimentacao.responsavel.nome %></td>
                <% if current_user.has_role?(:tec_serv_ti) %>
                  <td><%= movimentacao.user&.nome || 'N/A' %></td>
                <% end %>
                <td>
                  <% status_class = case movimentacao.status
                     when 'em_andamento' then 'warning'
                     when 'concluida' then 'success'
                     when 'cancelada' then 'danger'
                     end %>
                  <span class="badge badge-<%= status_class %>">
                    <%= movimentacao.status.humanize %>
                  </span>
                </td>
                <td>
                  <%= movimentacao.equipamentos_recebidos_count %> / <%= movimentacao.total_equipamentos %>
                  <% if movimentacao.equipamentos_pendentes_count > 0 %>
                    <span class="badge badge-warning">
                      <%= movimentacao.equipamentos_pendentes_count %> pendente(s)
                    </span>
                  <% end %>
                </td>
                <td><%= movimentacao.data_movimentacao&.strftime("%d/%m/%Y %H:%M") %></td>
                <td>
                  <%= link_to movimentacao_equipamento_path(movimentacao), class: "btn btn-sm btn-info", title: "Ver Detalhes" do %>
                    <i class="fas fa-eye"></i>
                  <% end %>
                  
                  <% if movimentacao.pode_ser_cancelada? && current_user.has_role?(:tec_serv_ti) && current_user.id == movimentacao.user_id %>
                    <%= link_to cancelar_movimentacao_equipamento_path(movimentacao), 
                        method: :patch, 
                        class: "btn btn-sm btn-danger", 
                        title: "Cancelar Movimentação",
                        data: { confirm: "Tem certeza que deseja cancelar esta movimentação? Esta ação não pode ser desfeita." } do %>
                      <i class="fas fa-times"></i>
                    <% end %>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      
      <div class="d-flex justify-content-center">
        <%= paginate @movimentacoes %>
      </div>
    <% else %>
      <div class="alert alert-info">
        <i class="fas fa-info-circle"></i>
        <% if current_user.has_role?(:tec_serv_ti) %>
          Nenhuma movimentação encontrada.
        <% elsif current_user.has_role?(:req_serv_ti) %>
          Você não possui movimentações pendentes.
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<% content_for :javascripts do %>
<script>
  $(function(){
    function bindAutocompleteWithHidden(inputSelector, hiddenSelector, url){
      $(inputSelector).autocomplete({
        minLength: 0,
        appendTo: 'body',
        position: { my: "left top", at: "left bottom", collision: "none" },
        source: function(request, response){
          $.getJSON(url, { term: request.term }, function(data){
            response($.map(data, function(item){ return { label: item.value, value: item.value, id: item.id }; }));
          });
        },
        select: function(event, ui){
          $(hiddenSelector).val(ui.item.id);
          $(inputSelector).val(ui.item.value).trigger('change');
          return false;
        },
        change: function(event, ui){ if(!ui.item){ $(hiddenSelector).val(''); } }
      }).autocomplete("widget").addClass("ui-autocomplete-modal");

      $(inputSelector).on('focus', function(){ $(this).autocomplete("search", ""); });
      $(inputSelector).on('input', function(){ if($(this).val() === '') { $(hiddenSelector).val(''); } });
    }

    bindAutocompleteWithHidden('.js-autocomplete-unidade', '#mov_equip_unidade_id', '/autocompletes/unidades');
    bindAutocompleteWithHidden('.js-autocomplete-usuario-criador', '#mov_equip_user_id', '/autocompletes/usuarios');
    bindAutocompleteWithHidden('.js-autocomplete-usuario-responsavel', '#mov_equip_responsavel_id', '/autocompletes/usuarios');

    $('<style>')
      .prop('type', 'text/css')
      .html(`
        .ui-autocomplete-modal {
          z-index: 9999 !important;
          max-height: 200px;
          overflow-y: auto;
          overflow-x: hidden;
        }
        .ui-autocomplete-modal .ui-menu-item { padding: 8px 12px; border-bottom: 1px solid #eee; cursor: pointer; }
        .ui-autocomplete-modal .ui-menu-item:hover { background-color: #f8f9fa; }
        .ui-autocomplete-modal .ui-menu-item:last-child { border-bottom: none; }
      `)
      .appendTo('head');
  })
</script>
<% end %>
